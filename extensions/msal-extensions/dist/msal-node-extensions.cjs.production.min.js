"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("fs"),r=require("util"),t=require("process"),n=require("path"),o=require("keytar");const i=function(){function e(){}return e.prototype.then=function(r,t){const n=new e,o=this.s;if(o){const e=1&o?r:t;if(e){try{c(n,1,e(this.v))}catch(e){c(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?c(n,1,r?r(o):o):t?c(n,1,t(o)):c(n,2,o)}catch(e){c(n,2,e)}},n},e}();function c(e,r,t){if(!e.s){if(t instanceof i){if(!t.s)return void(t.o=c.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(c.bind(null,e,r),c.bind(null,e,2));e.s=r,e.v=t;const n=e.o;n&&n(e)}}function s(e){return e instanceof i&&1&e.s}function u(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}function a(e,r){try{var t=e()}catch(e){return r(!0,e)}return t&&t.then?t.then(r.bind(null,!1),r.bind(null,!0)):r(!1,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,r){return(f=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e})(e,r)}function h(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function m(e,r,t){return(m=h()?Reflect.construct:function(e,r,t){var n=[null];n.push.apply(n,r);var o=new(Function.bind.apply(e,n));return t&&f(o,t.prototype),o}).apply(null,arguments)}function P(e){var r="function"==typeof Map?new Map:void 0;return(P=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return m(e,arguments,l(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),f(t,e)})(e)}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var v,y=function(e){var r,t;function n(r,t){var o;return o=e.call(this,t?r+": "+t:r)||this,Object.setPrototypeOf(function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(o),n.prototype),o.errorCode=r,o.errorMessage=t,o.name="PersistenceError",o}return t=e,(r=n).prototype=Object.create(t.prototype),r.prototype.constructor=r,r.__proto__=t,n.createFileSystemError=function(e,r){return new n(e,r)},n.createLibSecretError=function(e,r){return new n("GnomeKeyringError","Error accessing Gnome Keyring: "+e+"- "+r)},n.createKeychainPersistenceError=function(e,r){return new n("KeychainError","Error accessing Keychain: "+e+"- "+r)},n.createFilePersistenceWithDPAPIError=function(e,r){return new n("DPAPIEncryptedFileError","Error accessing DPAPI encrypted file: "+e+"- "+r)},n.createCrossPlatformLockError=function(e,r){return new n("CrossPlatformLockError","Error acquiring lock: "+e+"- "+r)},n}(P(Error)),d=function(){function n(e,r){this.lockFilePath=e,this.retryNumber=r?r.retryNumber:500,this.retryDelay=r?r.retryDelay:100}var o=n.prototype;return o.lock=function(){try{var n=!1,o=this,a=t.pid.toString(),l=0;return Promise.resolve(function(e,r,t){for(var n;;){var o=e();if(s(o)&&(o=o.v),!o)return u;if(o.then){n=0;break}var u=t();if(u&&u.then){if(!s(u)){n=1;break}u=u.s}if(r){var a=r();if(a&&a.then&&!s(a)){n=2;break}}}var l=new i,f=c.bind(null,l,2);return(0===n?o.then(m):1===n?u.then(h):a.then(P)).then(void 0,f),l;function h(n){u=n;do{if(r&&(a=r())&&a.then&&!s(a))return void a.then(P).then(void 0,f);if(!(o=e())||s(o)&&!o.v)return void c(l,1,u);if(o.then)return void o.then(m).then(void 0,f);s(u=t())&&(u=u.v)}while(!u||!u.then);u.then(h).then(void 0,f)}function m(e){e?(u=t())&&u.then?u.then(h).then(void 0,f):h(u):c(l,1,u)}function P(){(o=e())?o.then?o.then(m).then(void 0,f):m(o):c(l,1,u)}}((function(){return!n&&l<o.retryNumber}),(function(){return l++}),(function(){return u((function(){console.log("Pid "+t.pid+" trying to acquire lock");var i=r.promisify(e.open);return Promise.resolve(i(o.lockFilePath,"wx+")).then((function(i){o.lockFileDescriptor=i,console.log("Pid "+t.pid+" acquired lock");var c=r.promisify(e.write);return Promise.resolve(c(o.lockFileDescriptor,a)).then((function(){n=!0}))}))}),(function(e){return function(){if("EEXIST"==e.code)return console.log(e),Promise.resolve(o.sleep(o.retryDelay)).then((function(){}));throw y.createCrossPlatformLockError(e.code,e.message)}()}))})))}catch(e){return Promise.reject(e)}},o.unlock=function(){try{var t=this;return Promise.resolve(u((function(){var n=r.promisify(e.unlink);return Promise.resolve(n(t.lockFilePath)).then((function(){var n=r.promisify(e.close);return Promise.resolve(n(t.lockFileDescriptor)).then((function(){}))}))}),(function(e){if("ENOENT"!=e.code)throw y.createCrossPlatformLockError(e.code,e.message);console.log("Lockfile does not exist")})))}catch(e){return Promise.reject(e)}},o.sleep=function(e){return new Promise((function(r){setTimeout(r,e)}))},n}(),p=function(){function e(e,r){this.persistence=e,this.lockFilePath=this.persistence.getFilePath()+".lockfile",this.lastSync=0,this.currentCache=null,this.lockOptions=r}var r=e.prototype;return r.readFromStorage=function(){try{var e=this;return console.log("Reading from storage"),Promise.resolve(e.persistence.reloadNecessary(e.lastSync)).then((function(r){function n(){return e.currentCache}var o=function(){if(r||null==e.currentCache){var n=a((function(){return console.log("Reload necessary.  Last sync time: "+e.lastSync),e.crossPlatformLock=new d(e.lockFilePath,e.lockOptions),Promise.resolve(e.crossPlatformLock.lock()).then((function(){return Promise.resolve(e.persistence.load()).then((function(r){e.currentCache=r,e.lastSync=(new Date).getTime(),console.log("Last sync time updated to: ",e.lastSync)}))}))}),(function(r,n){return Promise.resolve(e.crossPlatformLock.unlock()).then((function(){if(delete e.crossPlatformLock,console.log("Pid "+t.pid+" Released lock"),r)throw n;return n}))}));if(n&&n.then)return n.then((function(){}))}}();return o&&o.then?o.then(n):n()}))}catch(e){return Promise.reject(e)}},r.writeToStorage=function(e){try{var r=this,n=a((function(){return console.log("Writing to storage"),r.crossPlatformLock=new d(r.lockFilePath,r.lockOptions),Promise.resolve(r.crossPlatformLock.lock()).then((function(){return Promise.resolve(r.persistence.reloadNecessary(r.lastSync)).then((function(t){function n(){return Promise.resolve(e(r.currentCache)).then((function(e){return r.currentCache=e,Promise.resolve(r.persistence.save(r.currentCache)).then((function(){}))}))}var o=function(){if(t)return console.log("Reload necessary.  Last sync time: "+r.lastSync),Promise.resolve(r.persistence.load()).then((function(e){r.currentCache=e,r.lastSync=(new Date).getTime(),console.log("Last sync time updated to: ",r.lastSync)}))}();return o&&o.then?o.then(n):n()}))}))}),(function(e,n){return Promise.resolve(r.crossPlatformLock.unlock()).then((function(){if(console.log("Pid "+t.pid+" Released lock"),e)throw n;return n}))}));return Promise.resolve(n&&n.then?n.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},e}(),g=function(){function t(){}t.create=function(e){try{var r=new t;return r.filePath=e,Promise.resolve(r.createCacheFile()).then((function(){return r}))}catch(e){return Promise.reject(e)}};var o=t.prototype;return o.save=function(t){try{var n=this,o=r.promisify(e.writeFile);return Promise.resolve(u((function(){return Promise.resolve(o(n.getFilePath(),t,"utf-8")).then((function(){}))}),(function(e){throw y.createFileSystemError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},o.saveBuffer=function(t){try{var n=this,o=r.promisify(e.writeFile);return Promise.resolve(u((function(){return Promise.resolve(o(n.getFilePath(),t)).then((function(){}))}),(function(e){throw y.createFileSystemError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},o.load=function(){try{var t=this,n=r.promisify(e.readFile);return Promise.resolve(u((function(){return Promise.resolve(n(t.getFilePath(),"utf-8"))}),(function(e){throw y.createFileSystemError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},o.loadBuffer=function(){try{var t=this,n=r.promisify(e.readFile);return Promise.resolve(u((function(){return Promise.resolve(n(t.getFilePath()))}),(function(e){throw y.createFileSystemError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},o.delete=function(){try{var t=this,n=r.promisify(e.unlink);return Promise.resolve(u((function(){return Promise.resolve(n(t.getFilePath())).then((function(){return!0}))}),(function(e){if("ENOENT"==e.code)return!1;throw y.createFileSystemError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},o.getFilePath=function(){return this.filePath},o.reloadNecessary=function(e){try{return Promise.resolve(this.timeLastModified()).then((function(r){return e<r}))}catch(e){return Promise.reject(e)}},o.timeLastModified=function(){try{var t=this;return Promise.resolve(u((function(){var n=r.promisify(e.stat);return Promise.resolve(n(t.filePath)).then((function(e){return e.mtime.getTime()}))}),(function(e){if("ENOENT"==e.code)return 0;throw y.createFileSystemError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},o.createCacheFile=function(){try{var t=this;return Promise.resolve(t.createFileDirectory()).then((function(){var n=r.promisify(e.close),o=r.promisify(e.open);return Promise.resolve(o(t.filePath,"a")).then((function(e){return Promise.resolve(n(e)).then((function(){}))}))}))}catch(e){return Promise.reject(e)}},o.createFileDirectory=function(){try{var t=this;return Promise.resolve(u((function(){var o=r.promisify(e.mkdir);return Promise.resolve(o(n.dirname(t.filePath),{recursive:!0})).then((function(){}))}),(function(e){if("EEXIST"!=e.code)throw y.createFileSystemError(e.code,e.message);console.log("Directory "+n.dirname(t.filePath)+' " already exists"')})))}catch(e){return Promise.reject(e)}},t}(),w=require("bindings")("dpapi"),E=function(){function e(e,r){this.scope=e,this.optionalEntropy=r?Buffer.from(r,"utf-8"):null}e.create=function(r,t,n){try{var o=new e(t,n);return Promise.resolve(g.create(r)).then((function(e){return o.filePersistence=e,o}))}catch(e){return Promise.reject(e)}};var r=e.prototype;return r.save=function(e){try{var r=this;return Promise.resolve(u((function(){var t=w.protectData(Buffer.from(e,"utf-8"),r.optionalEntropy,r.scope.toString());return Promise.resolve(r.filePersistence.saveBuffer(t)).then((function(){}))}),(function(e){throw y.createFilePersistenceWithDPAPIError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},r.load=function(){try{var e=this;return Promise.resolve(u((function(){return Promise.resolve(e.filePersistence.loadBuffer()).then((function(r){return void 0!==r&&r&&0!==r.length?w.unprotectData(r,e.optionalEntropy,e.scope.toString()).toString():null}))}),(function(e){throw y.createFilePersistenceWithDPAPIError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},r.delete=function(){try{return Promise.resolve(this.filePersistence.delete())}catch(e){return Promise.reject(e)}},r.reloadNecessary=function(e){try{return Promise.resolve(this.filePersistence.reloadNecessary(e))}catch(e){return Promise.reject(e)}},r.getFilePath=function(){return this.filePersistence.getFilePath()},e}();(v=exports.DataProtectionScope||(exports.DataProtectionScope={})).CurrentUser="CurrentUser",v.LocalMachine="LocalMachine";var F=function(){function e(e,r){this.serviceName=e,this.accountName=r}e.create=function(r,t,n){try{var o=new e(t,n);return Promise.resolve(g.create(r)).then((function(e){return o.filePersistence=e,o}))}catch(e){return Promise.reject(e)}};var r=e.prototype;return r.save=function(e){try{var r=function(e){return t?e:Promise.resolve(n.filePersistence.save("{}")).then((function(){}))},t=!1,n=this,i=u((function(){return Promise.resolve(o.setPassword(n.serviceName,n.accountName,e)).then((function(){}))}),(function(e){throw y.createKeychainPersistenceError(e.code,e.message)}));return Promise.resolve(i&&i.then?i.then(r):r(i))}catch(e){return Promise.reject(e)}},r.load=function(){try{var e=this;return Promise.resolve(u((function(){return Promise.resolve(o.getPassword(e.serviceName,e.accountName))}),(function(e){throw y.createKeychainPersistenceError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},r.delete=function(){try{var e=this;return Promise.resolve(u((function(){return Promise.resolve(o.deletePassword(e.serviceName,e.accountName))}),(function(e){throw y.createKeychainPersistenceError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},r.reloadNecessary=function(e){try{return Promise.resolve(this.filePersistence.reloadNecessary(e))}catch(e){return Promise.reject(e)}},r.getFilePath=function(){return this.filePersistence.getFilePath()},e}(),S=function(){function e(e,r){this.serviceName=e,this.accountName=r}e.create=function(r,t,n){try{var o=new e(t,n);return Promise.resolve(g.create(r)).then((function(e){return o.filePersistence=e,o}))}catch(e){return Promise.reject(e)}};var r=e.prototype;return r.save=function(e){try{var r=function(e){return t?e:Promise.resolve(n.filePersistence.save("{}")).then((function(){}))},t=!1,n=this,i=u((function(){return Promise.resolve(o.setPassword(n.serviceName,n.accountName,e)).then((function(){}))}),(function(e){throw y.createLibSecretError(e.code,e.message)}));return Promise.resolve(i&&i.then?i.then(r):r(i))}catch(e){return Promise.reject(e)}},r.load=function(){try{var e=this;return Promise.resolve(u((function(){return Promise.resolve(o.getPassword(e.serviceName,e.accountName))}),(function(e){throw y.createLibSecretError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},r.delete=function(){try{var e=this;return Promise.resolve(u((function(){return Promise.resolve(o.deletePassword(e.serviceName,e.accountName))}),(function(e){throw y.createLibSecretError(e.code,e.message)})))}catch(e){return Promise.reject(e)}},r.reloadNecessary=function(e){try{return Promise.resolve(this.filePersistence.reloadNecessary(e))}catch(e){return Promise.reject(e)}},r.getFilePath=function(){return this.filePersistence.getFilePath()},e}();exports.FilePersistence=g,exports.FilePersistenceWithDataProtection=E,exports.KeychainPersistence=F,exports.LibSecretPersistence=S,exports.PersistenceCachePlugin=p;
//# sourceMappingURL=msal-node-extensions.cjs.production.min.js.map
